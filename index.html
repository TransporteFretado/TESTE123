<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta e Sugest√£o | Alumar</title>
    <style>
        :root {
            --primary: #165788;
            --secondary: #818A8F;
            --white: #FFFFFF;
            --whatsapp: #25d366;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333333;
            --border: #d1d5db;
            --accent: #16578810;
            --danger: #dc2626;
            --highlight: #fef9c3;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #111827;
                --card: #1f2937;
                --text: #f3f4f6;
                --border: #374151;
                --accent: #16578830;
                --highlight: #3f3f17;
            }
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; }

        /* Estilos do Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-alumar { width: 120px; }
        .header-titles h2 { font-size: 1.3rem; margin: 0; color: var(--primary); }
        
        /* Estilos da Busca e Filtros */
        .search-box { position: relative; width: 100%; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); box-sizing: border-box; }
        
        .filter-controls { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-btn { padding: 10px 14px; border-radius: 6px; cursor: pointer; background: var(--card); border: 1px solid var(--border); color: var(--text); font-weight: 600; font-size: 0.75rem; }
        .filter-btn.active { background: var(--primary); color: white; }

        .dropdown-content { display: none; position: absolute; background: var(--card); min-width: 180px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); z-index: 100; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 10px; cursor: pointer; font-size: 0.85rem; }
        .dropdown-item:hover { background: var(--accent); }

        /* Estilos da Tabela */
        .table-wrapper { background: var(--card); border-radius: 12px; overflow-x: auto; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { padding: 12px; text-align: left; background: #f9fafb; color: var(--secondary); font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 12px; border-top: 1px solid var(--border); font-size: 0.85rem; }
        
        /* Estilos do Formul√°rio de Sugest√£o */
        .form-container { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-top: 30px; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .input-group input, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); }
        
        .btn-share { background: var(--whatsapp); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #loader { text-align: center; padding: 40px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="logo.png" alt="Alumar" class="logo-alumar">
            <div class="header-titles">
                <h2>Consulta Itiner√°rios</h2>
                <p>Facilities & Security</p>
            </div>
        </div>
        <div id="relogio" style="font-family: monospace; font-weight: bold;"></div>
    </div>

    <div class="search-box">
        <input type="text" id="search" placeholder="Pesquisar por linha, bairro ou ponto...">
    </div>

    <div class="filter-controls">
        <button class="filter-btn" onclick="limparFiltros()">üîÑ Limpar</button>
        <div style="position: relative;">
            <button class="filter-btn" id="btnFiltroTurno" onclick="toggleDropdown('dropTurno')">Turno ‚ñæ</button>
            <div id="dropTurno" class="dropdown-content"></div>
        </div>
        <div style="position: relative;">
            <button class="filter-btn" id="btnFiltroBairro" onclick="toggleDropdown('dropBairro')">Bairro ‚ñæ</button>
            <div id="dropBairro" class="dropdown-content"></div>
        </div>
        <div style="position: relative;">
            <button class="filter-btn" id="btnFiltroLinha" onclick="toggleDropdown('dropLinha')">Linha ‚ñæ</button>
            <div id="dropLinha" class="dropdown-content"></div>
        </div>
    </div>

    <div id="loader">Carregando dados...</div>

    <div id="container-tabela" class="hidden">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Turno</th>
                        <th>Linha</th>
                        <th>Bairro</th>
                        <th>Ponto</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="form-container">
        <h3 style="color: var(--primary); margin-top: 0;">üìù Sugerir Nova Rota/Ponto</h3>
        <p style="font-size: 0.8rem; color: var(--secondary);">N√£o encontrou sua rota? Envie uma sugest√£o para an√°lise.</p>
        <form id="formSugestao">
            <div class="input-group">
                <input type="text" id="novoBairro" placeholder="Bairro" required>
                <input type="text" id="novoPonto" placeholder="Ponto de Refer√™ncia" required>
            </div>
            <textarea id="obs" placeholder="Alguma observa√ß√£o importante?" style="width: 100%; height: 60px;"></textarea>
            <button type="submit" id="btnEnviarDados" style="margin-top: 10px; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;">
                Salvar Sugest√£o no SharePoint
            </button>
        </form>
        <p id="statusEnvio" style="font-size: 0.85rem; margin-top: 10px; font-weight: bold; display: none;"></p>
    </div>
</div>

<script>
    let pontos = [];
    let filtroAtivo = { turno: null, bairro: null, linha: null };

    // --- L√ìGICA DE CONSULTA ---
    async function carregarCSV() {
        try {
            const resp = await fetch('pontos.csv?v=' + Date.now());
            const buffer = await resp.arrayBuffer();
            let decoder = new TextDecoder('utf-8');
            let data = decoder.decode(buffer);
            
            if (data.includes('')) {
                decoder = new TextDecoder('windows-1252');
                data = decoder.decode(buffer);
            }

            const linhas = data.split(/\r?\n/).filter(l => l.trim() !== "");
            pontos = linhas.slice(1).map(linha => {
                const sep = linha.includes(';') ? ';' : ',';
                const col = linha.split(sep).map(c => c.trim().replace(/^"|"$/g, ''));
                return { turno: col[0], linha: col[1], tipo: col[2], bairro: col[3], ponto: col[4], parada: col[5] };
            });

            aplicarFiltros();
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('container-tabela').classList.remove('hidden');
        } catch (e) { console.error(e); }
    }

    function aplicarFiltros() {
        const busca = document.getElementById('search').value.toLowerCase();
        let filtrados = pontos.filter(p => {
            const matchBusca = !busca || Object.values(p).some(v => v.toLowerCase().includes(busca));
            const matchTurno = !filtroAtivo.turno || p.turno === filtroAtivo.turno;
            const matchBairro = !filtroAtivo.bairro || p.bairro === filtroAtivo.bairro;
            const matchLinha = !filtroAtivo.linha || p.linha === filtroAtivo.linha;
            return matchBusca && matchTurno && matchBairro && matchLinha;
        });
        
        renderTabela(filtrados);
        atualizarMenus(busca);
    }

    function renderTabela(lista) {
        document.getElementById('tableBody').innerHTML = lista.map(p => `
            <tr>
                <td>${p.turno}</td>
                <td style="font-weight:bold; color:var(--primary)">${p.linha}</td>
                <td>${p.bairro}</td>
                <td>${p.ponto}</td>
                <td><button class="btn-share" onclick="compartilhar('${p.linha}')">üì≤ Enviar</button></td>
            </tr>
        `).join('');
    }

    function atualizarMenus(busca) {
        // L√≥gica de menus suspensos "vivos"
        const campos = ['turno', 'bairro', 'linha'];
        campos.forEach(campo => {
            const unicos = [...new Set(pontos.map(p => p[campo]))].filter(v => v).sort();
            document.getElementById('drop' + campo.charAt(0).toUpperCase() + campo.slice(1)).innerHTML = 
                unicos.map(v => `<div class="dropdown-item" onclick="setFiltro('${campo}', '${v}')">${v}</div>`).join('');
        });
    }

    function setFiltro(campo, valor) {
        filtroAtivo[campo] = valor;
        document.getElementById('btnFiltro' + campo.charAt(0).toUpperCase() + campo.slice(1)).classList.add('active');
        aplicarFiltros();
    }

    function limparFiltros() {
        filtroAtivo = { turno: null, bairro: null, linha: null };
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('search').value = "";
        aplicarFiltros();
    }

    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-content').forEach(d => d.id !== id && d.classList.remove('show'));
        document.getElementById(id).classList.toggle('show');
    }

    // --- L√ìGICA DE ENVIO PARA NUVEM ---
    document.getElementById('formSugestao').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviarDados');
        const status = document.getElementById('statusEnvio');
        
        const dados = {
            bairro: document.getElementById('novoBairro').value,
            ponto: document.getElementById('novoPonto').value,
            observacao: document.getElementById('obs').value,
            data: new Date().toLocaleString('pt-BR')
        };

        btn.disabled = true;
        btn.innerText = "Processando...";

        try {
            // LEMBRETE: Substitua a URL abaixo pela URL gerada no seu Power Automate
            const URL_WEBHOOK = "SUA_URL_DO_POWER_AUTOMATE_AQUI";

            const response = await fetch(URL_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });

            if (response.ok) {
                status.innerText = "‚úÖ Sugest√£o salva com sucesso!";
                status.style.color = "green";
                document.getElementById('formSugestao').reset();
            } else { throw new Error(); }
        } catch (err) {
            status.innerText = "‚ùå Erro ao conectar com o servidor.";
            status.style.color = "red";
        } finally {
            status.style.display = "block";
            btn.disabled = false;
            btn.innerText = "Salvar Sugest√£o no SharePoint";
        }
    });

    // Rel√≥gio e Inicializa√ß√£o
    setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString(); }, 1000);
    window.onload = carregarCSV;
    document.getElementById('search').addEventListener('input', aplicarFiltros);
</script>

</body>
</html>
